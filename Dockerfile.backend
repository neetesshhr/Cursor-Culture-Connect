FROM node:22-alpine

# Set working directory
WORKDIR /app

# Install dependencies needed for bcrypt and other native modules
RUN apk add --no-cache postgresql-client make gcc g++ python3 build-base

# Copy package.json and package-lock.json first for better caching
COPY backend/package*.json ./

# Install dependencies
RUN npm install --build-from-source

# Copy the entry scripts first
COPY backend/docker-entrypoint.sh /docker-entrypoint.sh
COPY backend/fix-db-config.sh ./fix-db-config.sh

# Set appropriate permissions
RUN chmod +x /docker-entrypoint.sh && chmod +x ./fix-db-config.sh

# Copy the rest of the backend
COPY backend/ .

# Expose API port
EXPOSE 5001

# Environment variables
ENV NODE_ENV=development
ENV PORT=5001

# Use our entry script
ENTRYPOINT ["/docker-entrypoint.sh"]

# Start the backend server
CMD ["npm", "run", "dev"] 